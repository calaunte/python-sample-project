openapi: 3.1.0

info:
  title: IP Geolocation Service
  version: 1.0.0
  description: |
    FastAPI microservice for IP address geolocation lookup.

    This service provides geolocation information for IPv4 addresses by integrating with ip-api.com.
    It supports both specific IP lookups and automatic client IP detection.

    ## Features
    - Look up geolocation for any public IPv4 address
    - Automatic client IP detection from request headers
    - Rich geolocation data (country, region, city, coordinates, timezone, ISP)
    - Comprehensive error handling with clear error messages
    - Health check endpoint with provider status

    ## Rate Limits
    Free tier: 45 requests per minute (provider limit)

    ## Error Handling
    All errors follow a consistent format with machine-readable error types and human-readable messages.
  contact:
    name: LivaNova Backend Engineering
    email: backend@livanova.com

servers:
  - url: http://localhost:8000
    description: Development server

tags:
  - name: geolocation
    description: IP address geolocation operations
  - name: health
    description: Service health check

paths:
  /api/v1/geolocate/{ip}:
    get:
      tags:
        - geolocation
      summary: Geolocate a specific IP address
      description: |
        Look up geolocation information for a specific IPv4 address.

        Returns comprehensive geolocation data including country, region, city, coordinates, timezone, and ISP information.
      operationId: geolocate_ip
      parameters:
        - name: ip
          in: path
          required: true
          description: IPv4 address to geolocate (e.g., "8.8.8.8")
          schema:
            type: string
            pattern: '^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$'
            example: "8.8.8.8"
      responses:
        '200':
          description: Geolocation data found successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GeolocationResponse'
              example:
                ip: "8.8.8.8"
                country: "United States"
                country_code: "US"
                region: "California"
                region_code: "CA"
                city: "Mountain View"
                zip_code: "94035"
                latitude: 37.386
                longitude: -122.0838
                timezone: "America/Los_Angeles"
                isp: "Google LLC"
                organization: "Google Public DNS"
                as_number: "AS15169"
                as_name: "GOOGLE"
        '400':
          description: Invalid IP address format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error:
                  type: "invalid_ip"
                  message: "Invalid IPv4 address: not-an-ip"
        '404':
          description: IP address not found in geolocation database
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error:
                  type: "ip_not_found"
                  message: "Geolocation data not found for IP: 1.2.3.4"
        '422':
          description: Private or reserved IP address
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error:
                  type: "private_ip"
                  message: "Cannot geolocate private/reserved IP: 192.168.1.1"
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error:
                  type: "rate_limit_exceeded"
                  message: "Rate limit exceeded for provider: ip-api.com"
        '503':
          description: Geolocation provider unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error:
                  type: "provider_unavailable"
                  message: "Geolocation provider ip-api.com is unavailable: HTTP 503"

  /api/v1/geolocate:
    get:
      tags:
        - geolocation
      summary: Geolocate the requesting client's IP address
      description: |
        Automatically detect and geolocate the client's IP address from request headers.

        The service tries headers in this order:
        1. X-Forwarded-For (most common for proxied requests)
        2. X-Real-IP (alternative proxy header)
        3. Direct connection IP

        This is useful for determining the location of the requesting client.
      operationId: geolocate_client_ip
      responses:
        '200':
          description: Geolocation data found successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GeolocationResponse'
        '400':
          description: Unable to determine client IP or invalid IP format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error:
                  type: "client_ip_detection_failed"
                  message: "Unable to determine client IP address"
        '404':
          description: IP address not found in geolocation database
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Private or reserved IP address
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: Geolocation provider unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /health:
    get:
      tags:
        - health
      summary: Health check
      description: |
        Check if the service and geolocation provider are available.

        Returns:
        - `healthy`: Service and provider are operational
        - `degraded`: Service is running but provider is unavailable
        - `unhealthy`: Service is not operational
      operationId: health_check
      responses:
        '200':
          description: Health status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthCheckResponse'
              examples:
                healthy:
                  summary: Service is healthy
                  value:
                    status: "healthy"
                    version: "1.0.0"
                    provider: "ip-api.com"
                    provider_status: "available"
                degraded:
                  summary: Service is degraded
                  value:
                    status: "degraded"
                    version: "1.0.0"
                    provider: "ip-api.com"
                    provider_status: "unavailable"

components:
  schemas:
    GeolocationResponse:
      type: object
      required:
        - ip
        - country
        - country_code
        - region
        - region_code
        - city
        - latitude
        - longitude
        - timezone
        - isp
        - organization
        - as_number
        - as_name
      properties:
        ip:
          type: string
          description: IPv4 address
          example: "8.8.8.8"
        country:
          type: string
          description: Country name
          example: "United States"
        country_code:
          type: string
          description: ISO 3166-1 alpha-2 country code
          example: "US"
        region:
          type: string
          description: Region or state name
          example: "California"
        region_code:
          type: string
          description: Region or state code
          example: "CA"
        city:
          type: string
          description: City name
          example: "Mountain View"
        zip_code:
          type: string
          nullable: true
          description: Postal or ZIP code
          example: "94035"
        latitude:
          type: number
          format: float
          description: Latitude coordinate
          example: 37.386
        longitude:
          type: number
          format: float
          description: Longitude coordinate
          example: -122.0838
        timezone:
          type: string
          description: IANA timezone identifier
          example: "America/Los_Angeles"
        isp:
          type: string
          description: Internet Service Provider name
          example: "Google LLC"
        organization:
          type: string
          description: Organization name
          example: "Google Public DNS"
        as_number:
          type: string
          description: Autonomous System number
          example: "AS15169"
        as_name:
          type: string
          description: Autonomous System name
          example: "GOOGLE"

    HealthCheckResponse:
      type: object
      required:
        - status
        - version
        - provider
        - provider_status
      properties:
        status:
          type: string
          enum:
            - healthy
            - degraded
            - unhealthy
          description: Overall service health status
        version:
          type: string
          description: Service version
          example: "1.0.0"
        provider:
          type: string
          description: Geolocation provider name
          example: "ip-api.com"
        provider_status:
          type: string
          enum:
            - available
            - unavailable
          description: Provider availability status

    ErrorDetail:
      type: object
      required:
        - type
        - message
      properties:
        type:
          type: string
          description: Machine-readable error type code
          enum:
            - invalid_ip
            - private_ip
            - ip_not_found
            - rate_limit_exceeded
            - provider_unavailable
            - client_ip_detection_failed
        message:
          type: string
          description: Human-readable error message
        field:
          type: string
          nullable: true
          description: Field name for validation errors

    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          $ref: '#/components/schemas/ErrorDetail'
